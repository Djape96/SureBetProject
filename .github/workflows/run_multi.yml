name: Run multi script every 5 minutes

on:
  schedule:
    - cron: '*/5 * * * *'   # Every 5 minutes
  workflow_dispatch:

permissions:
  contents: read
  issues: write

concurrency:
  group: run-multi
  cancel-in-progress: true

jobs:
  run-multi:
    runs-on: ubuntu-latest
    timeout-minutes: 4  # Keep under 5 minutes to avoid overlap
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Debug env presence (masked)
        run: |
          echo "BOT TOKEN length: ${#TELEGRAM_BOT_TOKEN}"; echo "CHAT ID length: ${#TELEGRAM_CHAT_ID}"; [ -z "$TELEGRAM_BOT_TOKEN" ] && echo "(EMPTY TOKEN)" || echo "(TOKEN SET)"; [ -z "$TELEGRAM_CHAT_ID" ] && echo "(EMPTY CHAT ID)" || echo "(CHAT ID SET)"
      - name: Fail-fast secrets check
        run: |
          [ -z "$TELEGRAM_BOT_TOKEN" ] && echo "Missing TELEGRAM_BOT_TOKEN secret (add in Settings > Secrets and variables > Actions)" && exit 1 || echo "TELEGRAM_BOT_TOKEN present"
          [ -z "$TELEGRAM_CHAT_ID" ] && echo "Missing TELEGRAM_CHAT_ID secret (add in Settings > Secrets and variables > Actions)" && exit 1 || echo "TELEGRAM_CHAT_ID present"
          echo "Secrets OK"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies (if requirements.txt exists)
        if: hashFiles('requirements.txt') != ''
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run script
        run: |
          echo "Starting run at $(date)"
          set -o pipefail
          python run_multi.py --sequential 2>&1 | tee run_multi.log

      - name: List files after run
        if: always()
        run: |
          echo "Workspace contents:";
          ls -al . | head -100; echo "Logs dir (if any):"; ls -al logs || true; echo "Show log tail:"; tail -n 40 run_multi.log || echo "run_multi.log missing"

      - name: Upload run log artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: run_multi_log
          path: run_multi.log
          retention-days: 7

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const runId = process.env.GITHUB_RUN_ID;
            const sha = process.env.GITHUB_SHA;
            const repo = context.repo;
            const url = `https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId}`;
            const title = `run_multi failure ${new Date().toISOString()}`;
            const body = `Workflow run failed.\nRun: ${url}\nCommit: ${sha}\nPlease inspect the artifact log for details.`;
            await github.rest.issues.create({
              owner: repo.owner,
              repo: repo.repo,
              title,
              body
            });

      - name: Post-run summary
        if: always()
        run: |
          echo "Completed with conclusion: ${{ job.status }}"